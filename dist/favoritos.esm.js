/**
* favoritos
*
* @version 0.0.1-beta.0
* @author webistomin
* @email: webistomin@gmail.com
* @license: MIT
*
**/

var t,n,e;!function(t){t.CIRCLE="circle",t.RECT="rectangle"}(t||(t={})),function(t){t.TOP_LEFT="top-left",t.TOP_RIGHT="top-right",t.BOTTOM_LEFT="bottom-left",t.BOTTOM_RIGHT="bottom-right"}(n||(n={})),function(t){t.NONE="none",t.POP="pop",t.SLIDE="slide",t.FADE="fade",t.POP_FADE="popfade"}(e||(e={}));var i={icon:{iconSelector:'link[rel*="icon"]',backgroundColor:"#d21f3c",shape:t.CIRCLE,lineWidth:4,width:32,height:32},badge:{fontSize:18,fontFamily:"Helvetica, Arial, sans-serif",backgroundColor:"#d21f3c",color:"#ffffff",position:n.BOTTOM_RIGHT,animation:e.NONE,shape:t.CIRCLE,width:22,height:22}},o=function(t,n){var e=new CustomEvent(t,{bubbles:!0,detail:n});document.dispatchEvent(e)},a=window.matchMedia("(prefers-color-scheme: dark)");function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var c=Object.keys,s=function(t){return t&&"object"===r(t)&&!Array.isArray(t)&&!0},h=function t(n,e){var i,o,a=c(e);if(s(n)&&s(e))for(var r=0,h=a;r<h.length;r++){var d=h[r];s(e[d])?(n[d]||Object.assign(n,((i={})[d]={},i)),t(n[d],e[d])):Object.assign(n,((o={})[d]=e[d],o))}return n},d=function(t){return new Promise((function(n,e){var i=new Image;i.crossOrigin="anonymous",i.addEventListener("load",(function(){return n(i)}),{once:!0}),i.addEventListener("error",(function(t){return e(t)}),{once:!0}),i.src=t}))},l=function(){function t(t){if(this.userIconCache=null,this.badgeCounter=0,"undefined"==typeof window)console.warn("Favoritos was not initialised! Probably it is used in SSR.");else{var n=this.isPrefersColorSchemeDark(),e=i;n&&(e.badge.color="#121212",e.badge.backgroundColor="#ffffff",e.icon.backgroundColor="#ffffff"),this.options=h(e,t),this.init()}}return t.detectVisibilityChange=function(){"visible"===document.visibilityState?o("favoritos:visibilitychange","visible"):o("favoritos:visibilitychange","hidden")},t.detectThemeChange=function(t){var n=t.matches?"dark":"light";o("favoritos:themechange",n)},t.initListeners=function(){document.addEventListener("visibilitychange",t.detectVisibilityChange),a.addEventListener("change",t.detectThemeChange)},t.prototype.initIconCanvas=function(){var t=this.options,n=t.icon,e=t.badge,i=e.width,o=e.height,a=n.width,r=n.height;this.badgeCanvasWidth=i,this.badgeCanvasHeight=o,this.iconCanvas=document.createElement("canvas"),this.iconCanvasWidth=a,this.iconCanvasHeight=r,this.iconCanvas.width=a,this.iconCanvas.height=r,this.iconCanvasContext=this.iconCanvas.getContext("2d"),this.iconCanvasContext.font=e.fontSize+"px "+e.fontFamily,this.iconCanvasContext.textAlign="center",this.iconCanvasContext.textBaseline="middle"},t.prototype.getContextBackgroundColor=function(t,n,e){var i,o,a,r=this.iconCanvasContext;if(Array.isArray(t)){var c=r.createLinearGradient(0,0,n,e);(a=1/(o=t).length,o.map((function(t,n){return[n*a,t]}))).map((function(t){c.addColorStop(t[0],t[1])})),i=c}else i=t;return i},t.prototype.init=function(){var n=this,e=this.options.icon;this.iconElement=document.querySelector(e.iconSelector),this.userIconHref=this.iconElement.href,d(this.userIconHref).then((function(t){n.userIconCache=t})),this.initIconCanvas(),t.initListeners()},t.prototype.destroy=function(){document.removeEventListener("visibilitychange",t.detectVisibilityChange.bind(t)),a.removeEventListener("change",t.detectThemeChange.bind(t))},t.prototype.setOptions=function(t){this.options=h(this.options,t)},t.prototype.setIcon=function(t){this.iconElement.href=t},t.prototype.isPrefersColorSchemeDark=function(){return a.matches},t.prototype.reset=function(){this.options=i,this.setIcon(this.userIconHref)},t.prototype.drawBadge=function(t){var n=this;CanvasRenderingContext2D.prototype.roundRect=function(t,n,e,i,o){var a=t,r=n,c=e,s=i,h=o=Math.min(Math.max(e-1,1),Math.max(i-1,1),o);this.lineJoin="round",this.lineWidth=h,this.strokeRect(a+h/2,r+h/2,c-h,s-h),this.fillRect(a+h/2,r+h/2,c-h,s-h),this.stroke(),this.fill()};var e=function(e){var i=n.badgeCounter,o=n.options.icon,a=n.options.badge;t&&(i=t,n.badgeCounter=t);var r=i>=100?6:0;n.iconCanvasContext.clearRect(0,0,o.width,o.height),n.iconCanvasContext.drawImage(e,0,0,o.width,o.height),n.iconCanvasContext.fillStyle=n.getContextBackgroundColor(a.backgroundColor,n.iconCanvasWidth,n.iconCanvasHeight),n.iconCanvasContext.beginPath(),"circle"===a.shape?i>=10?(n.iconCanvasContext.strokeStyle=n.getContextBackgroundColor(a.backgroundColor,n.iconCanvasWidth,n.iconCanvasHeight),n.iconCanvasContext.roundRect(o.width-a.width-r,o.height-a.height,a.width+r,a.height,10)):n.iconCanvasContext.arc(o.width-a.width/2,o.height-a.height/2,a.width/2,0,2*Math.PI):n.iconCanvasContext.rect(o.width-a.width-r,o.height-a.height,a.width+r,a.height),n.iconCanvasContext.fill(),n.iconCanvasContext.fillStyle=a.color,n.iconCanvasContext.fillText(String(i),o.width-r/2-a.width/2,o.height-a.height/2+1.75,o.width),n.iconCanvasContext.closePath(),document.body.append(n.iconCanvas),n.iconElement.href=n.iconCanvas.toDataURL("image/png"),t||n.badgeCounter++};this.userIconCache?e(this.userIconCache):d(this.userIconHref).then((function(t){n.userIconCache=t,e(t)}))},t.prototype.setScrollingProgressBar=function(){var t=this.options.icon,n=document.documentElement.scrollTop/(document.documentElement.scrollHeight-document.documentElement.clientHeight)*100;this.iconCanvasContext.clearRect(0,0,t.width,t.height),this.iconCanvasContext.beginPath(),this.iconCanvasContext.lineWidth=t.lineWidth,this.iconCanvasContext.arc(t.width/2,t.height/2,t.width/2-t.lineWidth/2,1.5*Math.PI,2*n*Math.PI/100+1.5*Math.PI),this.iconCanvasContext.strokeStyle=this.getContextBackgroundColor(t.backgroundColor,32,32),this.iconCanvasContext.stroke(),this.iconElement.href=this.iconCanvas.toDataURL("image/png",1),document.body.append(this.iconCanvas)},t.prototype.drawLoader=function(){},t}();export default l;
