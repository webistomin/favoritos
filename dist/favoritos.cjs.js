/**
* favoritos
*
* @version 0.0.1-beta.0
* @author webistomin
* @email: webistomin@gmail.com
* @license: MIT
*
**/

"use strict";var t,e;!function(t){t.TOP_LEFT="top-left",t.TOP_RIGHT="top-right",t.BOTTOM_LEFT="bottom-left",t.BOTTOM_RIGHT="bottom-right"}(t||(t={})),function(t){t.CIRCLE="circle",t.RECT="rectangle"}(e||(e={}));var o={icon:{iconSelector:'link[rel*="icon"]',backgroundColor:"#d21f3c",shape:e.CIRCLE,lineWidth:4,width:32,height:32},badge:{fontSize:18,fontFamily:"Helvetica, Arial, sans-serif",backgroundColor:"#d21f3c",color:"#ffffff",position:t.BOTTOM_RIGHT,shape:e.CIRCLE,minWidth:22,minHeight:22}},i=Object.keys,n=function(t){return t&&"object"==typeof t&&!Array.isArray(t)&&!0},s=function(t,e){var o,r,a=i(e);if(n(t)&&n(e))for(var c=0,h=a;c<h.length;c++){var d=h[c];n(e[d])?(t[d]||Object.assign(t,((o={})[d]={},o)),s(t[d],e[d])):Object.assign(t,((r={})[d]=e[d],r))}return t},r=function(t,e){var o=new Image;o.crossOrigin="anonymous",o.addEventListener("load",(function(){return e(o)}),{once:!0}),o.addEventListener("error",(function(t){return e(o)}),{once:!0}),o.src=t},a=function(){function i(t){this.userIconCache=null,this.boundScrollProgressListener=this.setScrollingProgressBar.bind(this),this.scrollProgressOptions={useFavicon:!1},this.arcDegrees={0:0,90:.5*Math.PI,180:Math.PI,270:1.5*Math.PI,360:2*Math.PI},"undefined"==typeof window?console.warn("Favoritos was not initialised! Probably it is used in SSR."):(this.options=s(o,t),this.init())}return i.prototype.initIconCanvas=function(){var t=this.options,e=t.icon,o=t.badge,i=e.width,n=e.height;this.iconCanvas=document.createElement("canvas"),this.iconCanvas.width=i,this.iconCanvas.height=n,this.iconCanvasContext=this.iconCanvas.getContext("2d"),this.iconCanvasContext.font=o.fontSize+"px "+o.fontFamily,this.iconCanvasContext.textAlign="center",this.iconCanvasContext.textBaseline="middle"},i.prototype.getContextBackgroundColor=function(t,e,o){var i,n,s,r=this.iconCanvasContext;if(Array.isArray(t)){var a=r.createLinearGradient(0,0,e,o);(s=1/((n=t).length-1),n.map((function(t,e){return[e*s,t]}))).map((function(t){a.addColorStop(t[0],t[1])})),i=a}else i=t;return i},i.prototype.init=function(){var t=this,e=this.options.icon;this.iconElement=document.querySelector(e.iconSelector),this.userIconHref=this.iconElement.href,r(this.userIconHref,(function(e){t.userIconCache=e})),this.initIconCanvas()},i.prototype.destroy=function(){document.removeEventListener("scroll",this.boundScrollProgressListener)},i.prototype.setOptions=function(t){this.options=s(this.options,t)},i.prototype.setIcon=function(t){var e=this;this.iconElement.href=t,r(t,(function(t){e.userIconCache=t}))},i.prototype.reset=function(){this.options=o,this.setIcon(this.userIconHref)},i.prototype.getBadgeXPosition=function(o){var i=this.options,n=i.badge.minWidth,s=i.badge.position,r=i.icon.width,a=i.badge.shape,c=r,h=this.badgeContent>=10,d=n>=o?n:o>=c?c:o;switch(s){case t.TOP_LEFT:case t.BOTTOM_LEFT:switch(a){case e.CIRCLE:return h?0:d/2;case e.RECT:return 0}break;case t.TOP_RIGHT:case t.BOTTOM_RIGHT:switch(a){case e.CIRCLE:return h?r-d:r-d/2;case e.RECT:return r-d}}},i.prototype.getBadgeYPosition=function(o){var i=this.options,n=i.badge.position,s=i.icon.height,r=i.badge.minHeight,a=i.badge.shape,c=this.badgeContent>=10,h=r>=o?r:o;switch(n){case t.TOP_LEFT:case t.TOP_RIGHT:switch(a){case e.CIRCLE:return c?0:h/2;case e.RECT:return 0}break;case t.BOTTOM_LEFT:case t.BOTTOM_RIGHT:switch(a){case e.CIRCLE:return c?s-h:s-h/2;case e.RECT:return s-h}}},i.prototype.getBadgeTextXPosition=function(e){var o=this.options,i=o.badge.position,n=o.icon.width,s=o.badge.minWidth,r=s>=e?s:e>=n?n:e;switch(i){case t.TOP_RIGHT:case t.BOTTOM_RIGHT:return Math.abs(n-r/2);case t.TOP_LEFT:case t.BOTTOM_LEFT:return Math.abs(r/2)}},i.prototype.getBadgeTextYPosition=function(e){var o=this.options,i=o.badge.position,n=o.icon.height,s=o.badge.minHeight,r="number"==typeof this.badgeContent?.085*e:0,a=s>=e?s:e;switch(i){case t.TOP_RIGHT:case t.TOP_LEFT:return Math.abs(a/2+r);case t.BOTTOM_RIGHT:case t.BOTTOM_LEFT:return Math.abs(n-a/2+r)}},i.prototype.drawBadge=function(t){var o=this;void 0===t&&(t=0);var i=function(i){var n=o.iconCanvasContext;o.badgeContent=t;var s=t,r=o.options.icon,a=o.options.badge,c=o.iconCanvasContext.measureText(String(s)).width,h=a.fontSize;n.clearRect(0,0,r.width,r.height),n.drawImage(i,0,0,r.width,r.height),n.fillStyle=o.getContextBackgroundColor(a.backgroundColor,r.width,r.height),n.beginPath(),a.shape===e.CIRCLE?o.drawCircleBadge(c,h,s):o.drawRectBadge(c,h),n.fill(),n.fillStyle=a.color,n.fillText(String(s),o.getBadgeTextXPosition(c),o.getBadgeTextYPosition(h),r.width),n.closePath(),o.iconElement.href=o.iconCanvas.toDataURL("image/webp",1)};this.userIconCache?i(this.userIconCache):r(this.userIconHref,(function(t){o.userIconCache=t,i(t)}))},i.prototype.drawCircleBadge=function(t,e,o){var i=this.options,n=i.icon.width,s=i.icon.height,r=n,a=i.badge.minWidth,c=i.badge.minHeight,h=this.iconCanvasContext,d=a>=t?a:t>=r?r:t,g=c>=e?c:e;o>=10?(h.strokeStyle=this.getContextBackgroundColor(i.badge.backgroundColor,n,s),function(t,e,o,i,n,s){var r=e,a=o,c=i,h=n,d=Math.min(Math.max(i-1,1),Math.max(n-1,1),s);t.lineJoin="round",t.lineWidth=d,t.strokeRect(r+d/2,a+d/2,c-d,h-d),t.fillRect(r+d/2,a+d/2,c-d,h-d),t.stroke(),t.fill()}(h,this.getBadgeXPosition(t),this.getBadgeYPosition(e),d,g,10)):h.arc(this.getBadgeXPosition(t),this.getBadgeYPosition(e),d/2,this.arcDegrees[0],this.arcDegrees[360])},i.prototype.drawRectBadge=function(t,e){var o=this.options,i=o.icon.width,n=o.badge.minWidth,s=o.badge.minHeight,r=n>=t?n:t>=i?i:t,a=s>=e?s:e;this.iconCanvasContext.rect(this.getBadgeXPosition(t),this.getBadgeYPosition(e),r,a)},i.prototype.initScrollingProgressBar=function(t){void 0===t&&(t={useFavicon:!1}),this.scrollProgressOptions.useFavicon=t.useFavicon,document.addEventListener("scroll",this.boundScrollProgressListener)},i.prototype.setScrollingProgressBar=function(){var t=this,o=this.scrollProgressOptions.useFavicon,i=this.userIconCache,n=function(o){var i=t.options.icon,n=document.documentElement.scrollTop,s=document.documentElement.scrollHeight-document.documentElement.clientHeight,r=n/s*100,a=Math.round(r),c=t.iconCanvasContext;c.clearRect(0,0,i.width,i.height),o&&c.drawImage(o,0,0,i.width,i.height),c.beginPath(),c.lineWidth=i.lineWidth,i.shape===e.CIRCLE?t.drawCircleProgress(r):t.drawRectProgress(r),c.strokeStyle=t.getContextBackgroundColor(i.backgroundColor,32,32),c.stroke(),t.iconElement.href=t.iconCanvas.toDataURL("image/webp",1);var h=document.createEvent("CustomEvent");h.initCustomEvent("favoritos:scroll",!0,!0,{pageHeightInPx:s,scrollTopInPx:n,scrollPercent:r,scrollPercentRounded:a}),document.dispatchEvent(h)};o?i?n(i):r(this.userIconHref,(function(e){t.userIconCache=e,n(e)})):n()},i.prototype.drawCircleProgress=function(t){var e=this.options,o=this.iconCanvasContext,i=e.icon.width,n=e.icon.height,s=e.icon.lineWidth;o.arc(i/2,n/2,i/2-s/2,this.arcDegrees[270],t*this.arcDegrees[360]/100+this.arcDegrees[270])},i.prototype.drawRectProgress=function(t){var e=this.options,o=this.iconCanvasContext,i=e.icon.width,n=e.icon.height;t<=25?(o.moveTo(0,0),o.lineTo(i/25*t,0)):t>25&&t<=50?(o.moveTo(0,0),o.lineTo(i,0),o.moveTo(i,0),o.lineTo(i,n/25*(t-25))):t>50&&t<=75?(o.moveTo(0,0),o.lineTo(i,0),o.moveTo(i,0),o.lineTo(i,n),o.moveTo(i,n),o.lineTo(-i/25*(t-75),n)):t>75&&t<=100&&(o.moveTo(0,0),o.lineTo(i,0),o.moveTo(i,0),o.lineTo(i,n),o.moveTo(i,n),o.lineTo(0,n),o.moveTo(0,n),o.lineTo(0,-n/25*(t-100)))},i}();module.exports=a;